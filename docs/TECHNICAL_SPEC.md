# Техническое задание

Проект: визуальная новелла в стиле «Клуб Романтики» для Яндекс Игр
Рабочее название: **«Сердца на грани чудес»**
Версия ТЗ: 1.0

## 0) Цель продукта

Создать HTML5-игру (визуальная новелла с лёгкими мини-играми и романтическими ветвлениями), которая:

* стабильно работает на **Яндекс Играх** (веб, десктоп и мобильные браузеры);
* поддерживает **монетизацию**: IAP (встроенные покупки) + rewarded-реклама + внутриигровая экономика;
* имеет **контентный движок** (загрузка эпизодов из JSON без перекомпиляции);
* включает **первый эпизод** (готовый к релизу) и шаблон для добавления следующих.

---

## 1) Стек и целевые платформы

* **Платформа:** Web (HTML5) с публикацией в **Яндекс Играх**.
* **Технологии:**

  * Рендер/движок: **Phaser 3** (TypeScript).
  * Язык: **TypeScript** (ES2019+), сборка Vite или Webpack.
  * Стили: TailwindCSS или минимальный CSS (по выбору, но не тянуть тяжёлые UI-фреймворки).
  * Хранение: localStorage + синхронизация через Yandex Games SDK (при наличии авторизации).
* **Ограничения производительности:**

  * Итоговый **вес бандла ≤ 10 МБ** (без звука) для быстрого старта. Ассеты — лениво.
  * 60 FPS на средних Android (у́мная деградация анимаций на слабых устройствах).

---

## 2) Игровой дизайн (встроить как данные, а не как код)

### 2.1 Сеттинг и структура сезона

* Место: современный мистический мегаполис.
* Жанр: романтическая визуальная новелла + лёгкие головоломки.
* Сезонная структура: эпизоды (10–20 мин каждый). MVP: **Эпизод 1 — «Пропавший том»**.

### 2.2 Ресурсы и экономика

* `energy` — энергия для прохождения (время/ads/IAP).
* `runes` — премиум-валюта (IAP), открывает премиум-выборы/скипы.
* `hearts_kiana`, `hearts_ilya` — очки отношений.
* `clues` — улики (прогресс расследования).
* Восстановление энергии по таймеру + за рекламу. Экономику вынести в **config.json**.

### 2.3 Мини-игра (MVP)

* **glyph_match_1**: поле 3×3 с парами символов, соединение линий без пересечений.
* Стейты: Start → Play → Win/Lose → Retry/Hint/Skip.
* Награды/стоимости: из config.

### 2.4 Эпизод 1 (контент)

* Сцены: библиотека (вечер), подвал/архив, библиотечный холл, студия художницы, крыша, метро-тоннель, город ночью.
* Персонажи: Киана (2–3 эмоции), Илья (2 эмоции).
* Ветвления: романтические/расследовательские + премиум-выборы.
* Все тексты, выборы, условия, трата/начисление ресурсов — **в JSON-скрипте** (см. §5).

---

## 3) Фичи (минимум для релиза)

1. **Диалоговый движок**

   * Покадровая подача текста, спрайты персонажей, смена эмоций, фоны, музыка/эффекты.
   * Типы узлов: `say`, `choice`, `set`/`gain`, `check` (условия/ресурсы), `jump`, `bg`, `sprite`, `sfx`, `music`, `minigame`, `end`.
   * Премиум-выборы с проверкой `runes`. Энергозатраты на узлах.
   * Авто-сейв после каждой сцены + ручной сейв/лоад (1 слот минимум).

2. **Система ресурсов**

   * Отображение HUD: энергия, руны, улики, сердца (персонажно).
   * Таймер восстановления энергии (порог и шаг из config).
   * Безопасная арифметика ресурсов (границы, отрицания, кэп).

3. **Мини-игры (плагинная система)**

   * Интерфейс для встраивания мини-игр по ID из JSON.
   * Реализовать `glyph_match_1` и шаблон для будущих мини-игр.

4. **Монетизация**

   * **Rewarded Ads**: место вызова при нехватке энергии/подсказок.
   * **IAP**: пакеты энергии, пакеты рун, премиум-пропуск (опционально — без рекламы).
   * «Безопасный» фолбэк, если SDK недоступен: заглушки и информирование игрока.

5. **Интеграция с Яндекс Игры SDK**

   * Инициализация, авторизация (по желанию игрока), биллинг, реклама.
   * Сохранения/облако при авторизованном ID, иначе localStorage.
   * Локализация валют/цен по API.

6. **Аналитика (внутренняя, событийная)**

   * События: старт/финиш эпизода, просмотр рекламы (успех/отмена), покупка (успех/фейл), трата/получение ресурсов, вход в мини-игру, win/lose, выборы (без PII).
   * Лёгкий абстрактный интерфейс `Analytics.track(name, payload)`.

7. **Локализация**

   * RU как дефолт, i18n-слой (строки UI/ошибок/магазина в отдельном словаре).
   * Горячая замена языка (перезапуск сцены допустим).

8. **Доступность и UX**

   * Размер шрифта регулируемый (минимум 2 пресета).
   * Тап-зоны увеличены на мобильных.
   * Скип анимаций/автотекст по настройкам.
   * Цветоконтраст UI достаточный.

9. **Техническое меню/отладка (dev-build)**

   * Включение god mode: бесконечная энергия/руны.
   * Скип сцен, лог состояний, принт текущего узла.

---

## 4) Архитектура и модули

* `core/engine/` — интерпретатор узлов, состояние, маршрутизация, сейвы.
* `core/ui/` — диалоговое окно, HUD, меню, настройки, магазин.
* `core/minigames/` — интерфейсы + `glyph_match_1`.
* `core/platform/yandex/` — обёртки SDK: инициализация, Ads, IAP, cloud save.
* `core/analytics/` — единая точка событий.
* `content/episodes/` — **JSON-скрипты** эпизодов, ассеты (манифесты).
* `config/` — экономика, тайминги, продукты IAP, рекламные плейсменты, i18n.

**Требование:** движок не должен «знать» тексты/ветвления — всё в контентных JSON.

---

## 5) Формат контента (JSON-скрипт эпизода)

**Общее:**

```json
{
  "episodeId": "ep1",
  "title": "Пропавший том",
  "start": "A0",
  "nodes": {
    "A0": { "type": "bg", "bg": "bg_library_evening", "next": "A1" },
    "A1": { "type": "say", "who": "MC", "text": "…", "next": "A2" },
    "A2": {
      "type": "choice",
      "text": "Ответить Киане",
      "options": [
        {"id":"A2a","label":"…","gain":{"hearts_kiana":1},"next":"A3"},
        {"id":"A2b","label":"…","next":"A3"}
      ]
    },
    "…": {}
  }
}
```

**Обязательные типы узлов:** `bg`, `sprite`, `say`, `choice`, `set/gain`, `check (req)`, `jump`, `minigame`, `music/sfx`, `end`.
**Условия:** `req` поддерживает проверки ресурсов/флагов.
**Экономика в узлах:** поля `cost`/`gain` допускаются.
**Валидация:** линтер-скрипт проверяет непротиворечивость (`start` существует, все `next`/`jump` валидны, нет «висячих» узлов).

**Поставить в проект готовый эпизод «ep1.json»** (мы уже описали структуру и тексты; агент должен перенести/адаптировать без изменений сюжета).

---

## 6) Монетизация (реализация с заглушками)

* **Rewarded Ads**

  * Интерфейс: `Monetization.showRewarded(placementId) -> Promise<RewardResult>`
  * Результаты: `granted | canceled | error`. Начисления — только при `granted`.
  * Использования: нехватка энергии/подсказки в мини-игре.

* **IAP**

  * Продукты (из `config/products.json`):

    * `energy_pack_small` (+10 энергии),
    * `runes_pack_small` (+5 рун),
    * `premium_pass_week` (без рекламы и +ежедневные бонусы — опционально).
  * Интерфейс: `Monetization.purchase(productId) -> Promise<PurchaseResult>`
  * Идемпотентность: повторная выдача по незафиксированным транзакциям, журнал покупок.

* **Экономика**

  * Таймер энергии: период и максимум из `config/economy.json`.
  * Все значения (цены, награды) — в конфиге, без литералов в коде.

---

## 7) Сохранения и облако

* **Слоты:** авто-сейв + 1 ручной.
* **Содержимое сейва:** id эпизода, id узла, ресурсы, флаги, инвентарь мини-игры (если нужно), версия данных.
* **Локально:** localStorage с префиксом проекта и версионированием (миграции).
* **Облако:** при авторизованном YandexID — синхронизация (конфликты решать «новее побеждает», с бэкапом локального).

---

## 8) UI/UX: экраны и состояния

* **Главное меню:** «Играть», «Загрузить», «Магазин», «Настройки», «Справка».
* **Экран диалога:** фон, портреты, текст, кнопки выбора, HUD ресурсов.
* **Магазин:** список продуктов IAP, статус премиума, кнопка восстановить покупки.
* **Нехватка ресурса:** модалка с CTA: «Посмотреть рекламу» / «Купить» / «Позже».
* **Мини-игра:** отдельный лэйаут, кнопка «Повторить», «Подсказка», «Скип».
* **Настройки:** громкость, размер шрифта, язык, скорость текста, «пропуск анимаций».

---

## 9) Контент-пайплайн

* Добавление эпизода: положить `epX.json` в `content/episodes/`, ассоциированные ассеты — в `assets/` и `manifest.json`.
* Горячая загрузка эпизода по списку из `content/index.json`.
* Встроить **валидатор контента** (npm-скрипт), CI-проверки при коммите.

---

## 10) Аналитика (минимальный набор)

* `session_start`, `session_end`
* `episode_start`, `episode_end`
* `node_shown` (id узла, тип) — только в dev-режиме
* `choice_made` (id выбора) — без персональных данных
* `rewarded_shown`, `rewarded_granted`, `rewarded_canceled`
* `iap_attempt`, `iap_success`, `iap_fail`
* `resource_change` (тип, delta, причина)
  Реализация через консоль/провайдер-плагин, легко заменить на реальную.

---

## 11) Доступность, безопасность, конфиденциальность

* Без PII, минимальные cookie.
* Чёткое поведение при сбое сети (повтор при SDK-операциях, дружелюбные уведомления).
* Защита от «дважды выдать награду за одно и то же объявление».

---

## 12) Тестирование и приёмка

### 12.1 Тест-план (MVP)

* **Функциональные:** прохождение эпизода по всем веткам (включая премиум), корректная трата/начисление ресурсов, сейв/лоад.
* **Монетизация:** показ rewarded → начисление, отмена → без начисления; покупки IAP (успех/отмена/ошибка).
* **Мини-игра:** win/lose/retry/hint/skip — корректные награды/списания.
* **Сеть:** оффлайн-режим (без SDK) — корректные заглушки; восстановление после онлайна.
* **Производительность:** загрузка ≤ 5 сек на стабильном соединении, fps ≥ 30 на средних Android.
* **Мультиплатформенность:** Chrome/Firefox/Edge (desktop), Chrome/Firefox (Android), Safari (iOS — по возможности).

### 12.2 Acceptance Criteria (должно быть выполнено)

* Игра запускается, первый эпизод полностью проходим по всем веткам.
* Работают rewarded-плейсменты и IAP (с тестовыми продуктами).
* Энергия восстанавливается по таймеру; магазин корректно меняет балансы.
* Сейвы работают (локально), при авторизации — облачная синхронизация.
* Все тексты/ветвления хранятся в JSON, валидатор проходит без ошибок.
* Бандл ≤ 10 МБ (без тяжёлого аудио); lazy-load ассетов сцен.
* Нет фатальных ошибок в консоли; обработаны типовые сбои SDK.

---

## 13) Релизная подготовка

* **Сборка:** production build + source maps выключены, минификация.
* **Файлы для публикации:** index.html, bundle, ассеты, manifest, service worker (кэш базовых ассетов).
* **Яндекс Игр:** подключение SDK, тест продуктов, тест рекламных плейсментов, заполнение карточки (иконки 512×512 и 1024×1024, скриншоты 16:9, краткое/полное описание).
* **Политики:** краткая privacy/terms (без сбора PII).

---

## 14) Директория проекта (рекомендуемая)

```
/src
  /core
    /engine
    /ui
    /minigames
    /platform/yandex
    /analytics
  /scenes (инициализация, роутинг)
/content
  /episodes
    ep1.json
  index.json
/config
  economy.json
  products.json
  placements.json
  i18n.ru.json
  i18n.en.json
/assets
  /bg
  /characters
  /sfx
  /music
/public
  index.html
  sw.js
```

---

## 15) Документация в репозитории

* `README.md`: как собирать/запускать/публиковать.
* `CONTENT.md`: как писать новые эпизоды (JSON-схема, примеры узлов).
* `ECONOMY.md`: параметры экономики и как их менять.
* `QA.md`: чек-листы и сценарии приёмки.

---

## 16) Этапы и артефакты (для контроля выполнения)

1. **Архитектура + каркас (v0.1)**: сцена, загрузчик, рендер диалогов, смена фонов/спрайтов.
2. **Движок узлов (v0.2)**: `say/choice/set/check/jump/end`, сейвы, HUD.
3. **Монетизация каркас (v0.3)**: интерфейсы Ads/IAP, магазин (без SDK).
4. **Мини-игра (v0.4)**: подключаемая система + `glyph_match_1`.
5. **SDK-интеграция (v0.5)**: Яндекс SDK, тестовые биллинг/ads, облако.
6. **Контент ep1 (v0.6)**: импорты ассетов, прохождение всех веток.
7. **Оптимизация/UX/i18n (v0.7)**: настройки, шрифты, локализация.
8. **Релиз-кандидат (RC)**: тест-план пройден, бандл ≤ 10 МБ, карточка игры.

---

## 17) Что считать «готово»

* Репозиторий с исходниками, скриптами сборки и **полной документацией**.
* Рабочая сборка `dist/` готова к загрузке на Яндекс Игры.
* Эпизод 1 загружается из JSON, проходится по всем развилкам, экономика и монетизация работают согласно конфигам.
* Встроенные инструменты валидации контента и базовой аналитики включены.

---

Если где-то остаются неоднозначности — принимать решения в пользу: простоты расширения контентом, стабильности на мобильных и прозрачности экономики (никаких «неявных» трат/начислений).
